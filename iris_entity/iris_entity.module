<?php

function iris_entity_createEntity($entityType, $entityPropertiesArray, $credentials){
    
   $data = array(
    'credentials' => json_encode($credentials),
    );
  
  foreach($entityPropertiesArray as $key => $value){
  
    $data[$key] = json_encode($value);
    
  }
  
  $options = array(
    'method' => 'POST',
    'data' => drupal_http_build_query($data),
    'timeout' => 15,
    'headers' => array('Content-Type' => 'application/x-www-form-urlencoded'),
  );
  
  $result = drupal_http_request(variable_get("iris_server_address") . "/entity/create/".$entityType, $options);
      
}

function iris_entity_rules_action_info() {
  
  $data = array(
    'credentials' => json_encode(iris_auth_server_authenticate()),
  );

  $options = array(
    'method' => 'GET',
    'data' => drupal_http_build_query($data),
    'timeout' => 15,
    'headers' => array('Content-Type' => 'application/x-www-form-urlencoded'),
  );

  $result = drupal_http_request(variable_get("iris_server_address") . "/api/entitySchema", $options);
  
  // Array to place rules actions in
  
  $actions = array();
    
  if(!empty($result->data)){
    
    $data = json_decode($result->data);
    
    $counter = 1;
    
    $skipFields = array("entityType","eid", "_id", "id");
    
    foreach($data as $key => $value){
                  
      // Holder for current action's fields
      
      $current = array(
          'label' => t('Create a '.$key.' entity'), 
          'group' => t('Iris'), 
          'base' => "iris_entity_createEntity_".$key,
          'parameter' => array()
      );
            
      // Loop over fields and add them as a form item
            
      foreach($value as $fieldName => $fieldSettings){
        
        if(!isset($fieldSettings->fieldTypeName)){
          
          continue;
          
        }
                
        if($fieldSettings->fieldTypeName === "string"){
          
          $type = "text";
          
        } else if ($fieldSettings->fieldTypeName === "multistring") {
          
          $type = "list<text>";
          
        } else if ($fieldSettings->fieldTypeName === "boolean") {
          
          $type = "text";
          
        } else {
          
          $type = "text";
          
        }
                
        if(!in_array($fieldName, $skipFields)){ 

          $current['parameter'][$fieldName] = array(
                  'type' => 'text',
                  'label' => t($fieldName),
                  );
          }
        
      }
      
//      var_dump($current);
           
      $actions['create_iris_entity_'.$key] = $current;
    
    }

  
  }
    
  return $actions;

}
